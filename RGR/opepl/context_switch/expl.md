## ** 0. Компиляция и запуск**

```bash
qcc -O2 -Wc,-std=c99 -o ctxswitch ctxswitch.c
on -C 0 ./ctxswitch
```

## **1. Задание**

Измерить среднее время **контекстного переключения между двумя процессами** в QNX 6 с использованием аппаратного счётчика циклов и привязкой процессов к одному CPU.

---

## **2. Принцип работы программы**

1. **Два процесса**: родитель (client) и дочерний (server).
2. **Дочерний процесс** создаёт канал (`ChannelCreate`) и ждёт сообщений.
3. **Родительский процесс** подключается к каналу дочернего процесса (`ConnectAttach`).
4. Родительский процесс в цикле:

   * фиксирует время начала (`ClockCycles()`),
   * отправляет короткое сообщение дочернему процессу (`MsgSend`),
   * дочерний процесс тут же отвечает (`MsgReply`), что возвращает управление родителю,
   * фиксирует время окончания (`ClockCycles()`).
5. Разница времени включает **двойное переключение**: родитель → дочерний → родитель.
6. Деление на два даёт **время одного контекстного переключения**.

Программа повторяет эксперимент **1 000 000 раз** для усреднения результатов.

---

## **3. Программный код**

(Суть работы, без деталей pipe/attach)

```c
uint64_t t1 = ClockCycles();
MsgSend(coid, &msg, sizeof(msg), &reply, sizeof(reply));
uint64_t t2 = ClockCycles();
total_cycles += (t2 - t1);
```

* `MsgSend` → переключение в сервер.
* `MsgReply` → переключение обратно.
* `ClockCycles()` фиксирует время до и после двойного переключения.

---

## **4. Результаты эксперимента**

```
CPU frequency: 2688282000 Hz
Iterations: 1000000

Average CONTEXT SWITCH parent→child→parent:
  5906.02 cycles
  2196.95 ns

Estimated single switch:
  1098.48 ns
```

* Среднее время **двойного переключения**: 2196.95 нс.
* Среднее время **одного переключения**: 1098.48 нс.
* Полученное значение соответствует реальным затратам QNX на смену контекста между процессами на одном ядре.

---

## **5. Выводы**

* Программа корректно измеряет **время переключения процессов**, используя IPC и аппаратный счётчик.
* Усреднение по миллиону итераций позволяет снизить влияние случайных задержек.
* Время одного переключения (~1.1 мкс) согласуется с ожиданиями для ОС реального времени на данном процессоре.
* Привязка процессов к одному CPU необходима для исключения дополнительной задержки из-за миграции между ядрами.
